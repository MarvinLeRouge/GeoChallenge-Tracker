# Cache disque
proxy_cache_path /var/cache/nginx/tiles_cache
    levels=1:2
    keys_zone=tiles_cache:200m
    max_size=50g
    inactive=30d
    use_temp_path=off;

# Upstream OSM en HTTPS (rotation)
upstream osm_tiles {
    server a.tile.openstreetmap.org:443 max_fails=3 fail_timeout=10s;
    server b.tile.openstreetmap.org:443 max_fails=3 fail_timeout=10s;
    server c.tile.openstreetmap.org:443 max_fails=3 fail_timeout=10s;
}

server {
    listen 80;
    server_name _;

    # Santé rapide : http://host:8080/tiles/_health.png
    location = /tiles/_health.png {
        root /var/www;
        add_header Cache-Control "no-cache";
    }

    location /tiles/ {
        # retirer le préfixe /tiles/
        rewrite ^/tiles/(.*)$ /$1 break;

        proxy_pass https://osm_tiles;

        # TLS/SNI vers OSM
        proxy_ssl_server_name on;
        proxy_ssl_name tile.openstreetmap.org;

        # Headers attendus par OSM + identification
        proxy_set_header Host tile.openstreetmap.org;
        proxy_set_header User-Agent "GCTracker (+contact@exemple.tld)";
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # --- CACHE ---
        proxy_cache tiles_cache;
        proxy_cache_key $scheme$proxy_host$request_uri;

        # Respect de la fraîcheur amont
        proxy_cache_revalidate on;      # envoie If-None-Match/If-Modified-Since
        proxy_pass_header ETag;
        proxy_pass_header Last-Modified;

        # Eviter les avalanches
        proxy_cache_lock on;
        proxy_cache_lock_timeout 5s;

        # Validités: ne PAS écraser massivement les 200
        proxy_cache_valid 404 1m;
        proxy_cache_valid 500 502 503 504 1m;

        # Servir du stale si souci amont
        proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
        proxy_cache_background_update on;

        # Debug + cache côté client raisonnable
        add_header X-Cache-Status $upstream_cache_status always;
        add_header Cache-Control "public, max-age=2592000, s-maxage=2592000" always;

        # pas de cookies
        proxy_ignore_headers Set-Cookie;
        proxy_hide_header Set-Cookie;
    }
}
